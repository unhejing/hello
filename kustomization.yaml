apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Helm + Kustomize 组合配置
# 
# 工作流程：
# 1. Kustomize 使用 helmCharts 字段渲染 Helm Chart
# 2. Kustomize 对渲染后的资源添加 annotations 和 labels
# 3. ArgoCD 同步最终资源到集群
#
# 注意：需要在 ArgoCD ConfigMap 中启用 kustomize.buildOptions: --enable-helm

# 使用 helmCharts 字段引用本地 Helm Chart
helmCharts:
  - name: hello
    # 使用本地路径（相对于 kustomization.yaml）
    # 如果 Chart 在 charts/ 目录下，使用: charts/hello
    # 当前 Chart 在同一目录，使用: .
    path: .
    releaseName: hello-app
    namespace: default
    # 可选：指定 values 文件
    # valuesFile: values.yaml
    # 或者使用 valuesInline
    # valuesInline:
    #   replicaCount: 2

# 添加 annotations 到所有资源
commonAnnotations:
  argocd.argoproj.io/sync-wave: "0"
  managed-by: argocd
  generated-by: "helm+kustomize"

# 添加 labels 到所有资源
commonLabels:
  managed-by: argocd
  generated-by: "helm+kustomize"

# 命名空间
namespace: default

# 使用 patches 为特定资源添加或修改配置
patches:
  - target:
      kind: Deployment
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "0"
      - op: add
        path: /metadata/annotations/deployment.kubernetes.io~1revision
        value: "1"
  - target:
      kind: Service
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.kubernetes.io~1load-balancer-class
        value: "default"
