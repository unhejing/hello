apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Helm + Kustomize 组合配置
# 
# 重要说明：
# - helmCharts 字段不支持本地路径（.tgz 或目录）
# - helmCharts 只支持远程仓库（repo + version）
# - 对于本地 Chart，需要直接引用 templates 下的 YAML 文件
#
# 当前方案：直接引用 templates 目录下的 YAML 文件
# 注意：这不会使用 Helm 的 values.yaml，而是直接使用 Kustomize 处理
# 如果需要使用 Helm 渲染，应该使用远程 Chart 仓库

# 直接引用 templates 目录下的 YAML 文件
resources:
  - templates/deployment.yaml
  - templates/service.yaml
  - templates/configmap.yaml

# 添加 annotations 到所有资源
commonAnnotations:
  argocd.argoproj.io/sync-wave: "0"
  managed-by: argocd
  generated-by: "helm-kustomize"

# 添加 labels 到所有资源
# 注意：不要使用 commonLabels，因为它会应用到 selector，可能导致不可变错误
# 使用 patches 单独为每个资源添加 labels
# commonLabels:
#   managed-by: argocd
#   generated-by: "helm-kustomize"

# 命名空间
namespace: default

# 使用 patches 为特定资源添加或修改配置
patches:
  - target:
      kind: Deployment
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "0"
      - op: add
        path: /metadata/annotations/deployment.kubernetes.io~1revision
        value: "1"
      - op: replace
        path: /metadata/annotations/generated-by
        value: "helm-kustomize"
      - op: add
        path: /metadata/labels/managed-by
        value: "argocd"
      - op: add
        path: /metadata/labels/generated-by
        value: "helm-kustomize"
  - target:
      kind: Service
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.kubernetes.io~1load-balancer-class
        value: "default"
      - op: replace
        path: /metadata/annotations/generated-by
        value: "helm-kustomize"
      - op: add
        path: /metadata/labels/managed-by
        value: "argocd"
      - op: add
        path: /metadata/labels/generated-by
        value: "helm-kustomize"
