apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Helm + Kustomize 组合配置
# 
# 工作流程：
# 1. ArgoCD 使用 Helm 渲染 Chart（Application 中指定了 helm）
# 2. Kustomize 对 Helm 生成的资源添加 annotations 和 labels
# 3. ArgoCD 同步最终资源到集群
#
# 注意：
# - Application 中需要同时指定 helm 和 kustomize
# - 需要在 ArgoCD ConfigMap 中启用 kustomize.buildOptions: --enable-helm
# - 不要使用 helmCharts 字段（会导致重复渲染）

# 注意：resources 字段留空，ArgoCD 会自动使用 Helm 渲染的结果
# 如果使用 helmCharts 字段，会导致资源重复渲染
# resources: []

# 添加 annotations 到所有资源
commonAnnotations:
  argocd.argoproj.io/sync-wave: "0"
  managed-by: argocd
  generated-by: "helm+kustomize"

# 添加 labels 到所有资源
commonLabels:
  managed-by: argocd
  generated-by: "helm+kustomize"

# 命名空间
namespace: default

# 使用 patches 为特定资源添加或修改配置
patches:
  - target:
      kind: Deployment
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/argocd.argoproj.io~1sync-wave
        value: "0"
      - op: add
        path: /metadata/annotations/deployment.kubernetes.io~1revision
        value: "1"
  - target:
      kind: Service
      name: hello-app
    patch: |-
      - op: add
        path: /metadata/annotations/service.beta.kubernetes.io~1load-balancer-class
        value: "default"
